# G3ZKP Implementation Plan - Part 11
## Update & Push Protocols for Operators

---

## 1. VERSION MANAGEMENT

### 1.1 Semantic Versioning

```
MAJOR.MINOR.PATCH[-PRERELEASE][+BUILD]

Examples:
  1.0.0        - Initial release
  1.1.0        - New feature (backward compatible)
  1.1.1        - Bug fix
  2.0.0        - Breaking change
  1.2.0-beta.1 - Pre-release
  1.2.0+build.123 - Build metadata
```

### 1.2 Version Compatibility Matrix

| Component | Min Version | Max Version | Notes |
|-----------|-------------|-------------|-------|
| ZKP Circuits | 1.0.0 | Current | Breaking changes require migration |
| Crypto Protocol | 1.0.0 | Current | Must maintain backward compat |
| Network Protocol | 1.0.0 | Current | Version negotiation supported |
| Storage Schema | 1.0.0 | Current | Migrations auto-applied |

---

## 2. UPDATE TYPES

### 2.1 Hotfix (Emergency)

```yaml
hotfix:
  trigger: Critical security vulnerability or service outage
  approval: 1 senior engineer
  testing: Minimal smoke tests
  rollout: Immediate (all nodes)
  rollback: Automatic on failure
  notification: Real-time alerts
```

### 2.2 Patch Update

```yaml
patch:
  trigger: Bug fixes, minor improvements
  approval: 1 engineer
  testing: Full test suite
  rollout: Rolling (10% -> 50% -> 100%)
  rollback: Manual within 1 hour
  notification: 24 hours advance
```

### 2.3 Minor Update

```yaml
minor:
  trigger: New features (backward compatible)
  approval: 2 engineers
  testing: Full test suite + integration
  rollout: Canary (5% -> 25% -> 50% -> 100%)
  rollback: Manual within 24 hours
  notification: 1 week advance
```

### 2.4 Major Update

```yaml
major:
  trigger: Breaking changes
  approval: Tech lead + 2 engineers
  testing: Full suite + migration testing
  rollout: Staged with user communication
  rollback: Documented procedure
  notification: 1 month advance
```

---

## 3. UPDATE SCRIPTS

### 3.1 Check for Updates

**File: `scripts/operator/check-updates.sh`**

```bash
#!/bin/bash
set -euo pipefail

# G3ZKP Update Checker
# Usage: ./check-updates.sh

REGISTRY="ghcr.io/g3zkp"
CURRENT_VERSION=$(kubectl get deployment g3zkp-messenger -n g3zkp \
  -o jsonpath='{.spec.template.spec.containers[0].image}' | cut -d: -f2)

echo "=========================================="
echo "G3ZKP Update Checker"
echo "Current Version: $CURRENT_VERSION"
echo "=========================================="

# Fetch latest versions from registry
echo "Checking for updates..."

LATEST_STABLE=$(curl -s "https://api.github.com/repos/g3zkp/messenger/releases/latest" | \
  jq -r '.tag_name' | sed 's/^v//')

LATEST_BETA=$(curl -s "https://api.github.com/repos/g3zkp/messenger/releases" | \
  jq -r '[.[] | select(.prerelease==true)][0].tag_name' | sed 's/^v//')

echo ""
echo "Available Versions:"
echo "  Current:      $CURRENT_VERSION"
echo "  Latest Stable: $LATEST_STABLE"
echo "  Latest Beta:   $LATEST_BETA"
echo ""

# Compare versions
version_gt() {
  test "$(printf '%s\n' "$@" | sort -V | head -n 1)" != "$1"
}

if version_gt "$LATEST_STABLE" "$CURRENT_VERSION"; then
  echo "‚ö†Ô∏è  UPDATE AVAILABLE: $LATEST_STABLE"
  echo ""
  echo "Changelog:"
  curl -s "https://api.github.com/repos/g3zkp/messenger/releases/tags/v$LATEST_STABLE" | \
    jq -r '.body' | head -20
  echo ""
  echo "To update, run: ./scripts/operator/apply-update.sh $LATEST_STABLE"
else
  echo "‚úì You are running the latest stable version"
fi

# Check for security updates
echo ""
echo "Checking security advisories..."
SECURITY_UPDATES=$(curl -s "https://api.github.com/repos/g3zkp/messenger/security-advisories" | \
  jq -r '[.[] | select(.severity=="critical" or .severity=="high")][0].summary // "None"')
echo "Security Advisories: $SECURITY_UPDATES"
```

### 3.2 Apply Update

**File: `scripts/operator/apply-update.sh`**

```bash
#!/bin/bash
set -euo pipefail

# G3ZKP Update Applier
# Usage: ./apply-update.sh <version> [--force]

VERSION="${1:?Version required}"
FORCE="${2:-}"
NAMESPACE="g3zkp"
REGISTRY="ghcr.io/g3zkp"

echo "=========================================="
echo "G3ZKP Update"
echo "Target Version: $VERSION"
echo "=========================================="

# Pre-update checks
echo "[1/8] Running pre-update checks..."

CURRENT_VERSION=$(kubectl get deployment g3zkp-messenger -n $NAMESPACE \
  -o jsonpath='{.spec.template.spec.containers[0].image}' | cut -d: -f2)

if [ "$CURRENT_VERSION" = "$VERSION" ] && [ "$FORCE" != "--force" ]; then
  echo "Already running version $VERSION. Use --force to reinstall."
  exit 0
fi

# Create backup before update
echo "[2/8] Creating pre-update backup..."
./scripts/maintenance/backup.sh pre-update

# Pull and verify new image
echo "[3/8] Pulling new image..."
docker pull $REGISTRY/messenger:$VERSION

# Run security scan on new image
echo "[4/8] Running security scan..."
trivy image --exit-code 1 --severity CRITICAL $REGISTRY/messenger:$VERSION

# Check migration requirements
echo "[5/8] Checking migration requirements..."
MIGRATION_REQUIRED=$(docker run --rm $REGISTRY/messenger:$VERSION \
  node -e "console.log(require('./migrations').required('$CURRENT_VERSION', '$VERSION'))")

if [ "$MIGRATION_REQUIRED" = "true" ]; then
  echo "  Migration required. Running migrations..."
  kubectl exec -n $NAMESPACE deploy/g3zkp-messenger -- \
    node ./migrations/run.js "$CURRENT_VERSION" "$VERSION"
fi

# Apply update with rolling deployment
echo "[6/8] Applying update..."
kubectl set image deployment/g3zkp-messenger \
  g3zkp=$REGISTRY/messenger:$VERSION -n $NAMESPACE

# Wait for rollout
echo "[7/8] Waiting for rollout..."
kubectl rollout status deployment/g3zkp-messenger -n $NAMESPACE --timeout=600s

# Verify update
echo "[8/8] Verifying update..."
sleep 10
./scripts/deploy/health-check.sh

NEW_VERSION=$(kubectl get deployment g3zkp-messenger -n $NAMESPACE \
  -o jsonpath='{.spec.template.spec.containers[0].image}' | cut -d: -f2)

if [ "$NEW_VERSION" = "$VERSION" ]; then
  echo "=========================================="
  echo "‚úì Update successful: $VERSION"
  echo "=========================================="
else
  echo "=========================================="
  echo "‚úó Update verification failed"
  echo "Expected: $VERSION, Got: $NEW_VERSION"
  echo "Rolling back..."
  ./scripts/deploy/rollback.sh
  exit 1
fi
```

### 3.3 Rollback Update

**File: `scripts/operator/rollback-update.sh`**

```bash
#!/bin/bash
set -euo pipefail

# G3ZKP Update Rollback
# Usage: ./rollback-update.sh [revision]

NAMESPACE="g3zkp"
REVISION="${1:-}"

echo "=========================================="
echo "G3ZKP Rollback"
echo "=========================================="

# Show history
echo "Deployment History:"
kubectl rollout history deployment/g3zkp-messenger -n $NAMESPACE

echo ""
read -p "Confirm rollback? (yes/no): " confirm
[ "$confirm" = "yes" ] || exit 1

# Perform rollback
if [ -z "$REVISION" ]; then
  echo "Rolling back to previous version..."
  kubectl rollout undo deployment/g3zkp-messenger -n $NAMESPACE
else
  echo "Rolling back to revision $REVISION..."
  kubectl rollout undo deployment/g3zkp-messenger -n $NAMESPACE --to-revision=$REVISION
fi

# Wait for rollback
kubectl rollout status deployment/g3zkp-messenger -n $NAMESPACE --timeout=300s

# Verify
./scripts/deploy/health-check.sh

CURRENT=$(kubectl get deployment g3zkp-messenger -n $NAMESPACE \
  -o jsonpath='{.spec.template.spec.containers[0].image}')
echo "=========================================="
echo "Rollback complete. Current: $CURRENT"
echo "=========================================="
```

---

## 4. ZKP CIRCUIT UPDATES

### 4.1 Circuit Update Protocol

```bash
#!/bin/bash
# scripts/operator/update-circuits.sh

VERSION="${1:?Circuit version required}"
NAMESPACE="g3zkp"

echo "=========================================="
echo "G3ZKP Circuit Update"
echo "Version: $VERSION"
echo "=========================================="

# Download new circuit artifacts
echo "[1/5] Downloading circuit artifacts..."
aws s3 cp "s3://g3zkp-circuits/$VERSION/" /tmp/circuits/ --recursive

# Verify trusted setup
echo "[2/5] Verifying trusted setup..."
node -e "
  const snarkjs = require('snarkjs');
  const fs = require('fs');
  
  const circuits = ['authentication', 'message_security', 'forward_secrecy', 'composite_security'];
  
  for (const circuit of circuits) {
    const vkey = JSON.parse(fs.readFileSync('/tmp/circuits/' + circuit + '/verification_key.json'));
    console.log('‚úì ' + circuit + ' verification key valid');
  }
"

# Create ConfigMap with new circuits
echo "[3/5] Creating circuit ConfigMap..."
kubectl create configmap g3zkp-circuits-$VERSION \
  --from-file=/tmp/circuits/ \
  -n $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

# Update deployment to use new circuits
echo "[4/5] Updating deployment..."
kubectl patch deployment g3zkp-messenger -n $NAMESPACE --type=json \
  -p="[{\"op\":\"replace\",\"path\":\"/spec/template/spec/volumes/0/configMap/name\",\"value\":\"g3zkp-circuits-$VERSION\"}]"

# Restart pods
echo "[5/5] Rolling restart..."
kubectl rollout restart deployment/g3zkp-messenger -n $NAMESPACE
kubectl rollout status deployment/g3zkp-messenger -n $NAMESPACE

echo "=========================================="
echo "Circuit update complete: $VERSION"
echo "=========================================="
```

---

## 5. CLIENT UPDATE DISTRIBUTION

### 5.1 PWA Update

```javascript
// clients/pwa/src/update-handler.ts
export class PWAUpdateHandler {
  private registration: ServiceWorkerRegistration | null = null;

  async checkForUpdates(): Promise<boolean> {
    if (!this.registration) return false;
    
    await this.registration.update();
    return this.registration.waiting !== null;
  }

  async applyUpdate(): Promise<void> {
    if (!this.registration?.waiting) return;
    
    this.registration.waiting.postMessage({ type: 'SKIP_WAITING' });
    
    // Reload after new service worker activates
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }

  showUpdateNotification(): void {
    const notification = document.createElement('div');
    notification.innerHTML = `
      <div class="update-banner">
        <span>A new version is available</span>
        <button onclick="g3zkp.applyUpdate()">Update Now</button>
      </div>
    `;
    document.body.appendChild(notification);
  }
}
```

### 5.2 Android Update

```kotlin
// clients/android/UpdateManager.kt
class UpdateManager(private val context: Context) {
    private val appUpdateManager = AppUpdateManagerFactory.create(context)

    fun checkForUpdates() {
        val appUpdateInfoTask = appUpdateManager.appUpdateInfo

        appUpdateInfoTask.addOnSuccessListener { appUpdateInfo ->
            if (appUpdateInfo.updateAvailability() == UpdateAvailability.UPDATE_AVAILABLE
                && appUpdateInfo.isUpdateTypeAllowed(AppUpdateType.FLEXIBLE)) {
                
                requestUpdate(appUpdateInfo)
            }
        }
    }

    private fun requestUpdate(appUpdateInfo: AppUpdateInfo) {
        appUpdateManager.startUpdateFlowForResult(
            appUpdateInfo,
            AppUpdateType.FLEXIBLE,
            context as Activity,
            UPDATE_REQUEST_CODE
        )
    }

    companion object {
        const val UPDATE_REQUEST_CODE = 1001
    }
}
```

### 5.3 Desktop Update (Electron)

```typescript
// clients/desktop/electron/auto-updater.ts
import { autoUpdater } from 'electron-updater';
import { app, dialog, BrowserWindow } from 'electron';

export function setupAutoUpdater(mainWindow: BrowserWindow): void {
  autoUpdater.autoDownload = false;
  autoUpdater.autoInstallOnAppQuit = true;

  autoUpdater.on('update-available', (info) => {
    dialog.showMessageBox(mainWindow, {
      type: 'info',
      title: 'Update Available',
      message: `Version ${info.version} is available. Download now?`,
      buttons: ['Download', 'Later']
    }).then(result => {
      if (result.response === 0) {
        autoUpdater.downloadUpdate();
      }
    });
  });

  autoUpdater.on('update-downloaded', () => {
    dialog.showMessageBox(mainWindow, {
      type: 'info',
      title: 'Update Ready',
      message: 'Update downloaded. Restart to apply?',
      buttons: ['Restart', 'Later']
    }).then(result => {
      if (result.response === 0) {
        autoUpdater.quitAndInstall();
      }
    });
  });

  // Check for updates every hour
  setInterval(() => autoUpdater.checkForUpdates(), 60 * 60 * 1000);
  autoUpdater.checkForUpdates();
}
```

---

## 6. OPERATOR NOTIFICATION SYSTEM

### 6.1 Update Notifications

```yaml
# notification-config.yaml
notifications:
  channels:
    - type: slack
      webhook: ${SLACK_WEBHOOK_URL}
      events: [update_available, update_applied, update_failed]
    
    - type: email
      recipients: [ops@g3zkp.net]
      events: [security_update, major_update]
    
    - type: pagerduty
      service_key: ${PAGERDUTY_KEY}
      events: [update_failed, security_critical]

  templates:
    update_available: |
      üîÑ G3ZKP Update Available
      Version: {{version}}
      Type: {{update_type}}
      Changes: {{changelog_url}}
      
    update_applied: |
      ‚úÖ G3ZKP Update Applied
      Version: {{version}}
      Duration: {{duration}}
      Status: {{status}}
```

---

## 7. UPDATE SCHEDULE

```yaml
# Recommended update schedule for operators
schedule:
  security_patches:
    frequency: "As soon as available"
    max_delay: "24 hours"
    
  bug_fixes:
    frequency: "Weekly"
    window: "Tuesday 02:00-04:00 UTC"
    
  minor_updates:
    frequency: "Bi-weekly"
    window: "First Tuesday of sprint"
    
  major_updates:
    frequency: "Quarterly"
    window: "Scheduled maintenance window"
    preparation: "2 weeks testing in staging"
```

---

*Next: Part 12 - Operator Runbooks*
